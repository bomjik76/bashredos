#!/bin/bash


# Имя пользователя и пароль
echo "Создание пользователя Server_Admin"
USERNAME="Server_Admin"
PASSWORD="P@ssw0rd"
USER_ID=1010
# Создание пользователя
useradd -m -s /bin/bash -u "$USER_ID" "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd
usermod -aG wheel "$USERNAME"
# Настройка sudo без пароля
echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$USERNAME"
echo "Пользователь $USERNAME создан и настроен для использования sudo без пароля."

# Настройка порта SSH
echo "Настройка порта SSH..."
semanage port -a -t ssh_port_t -p tcp 2020
setenforce 0
sed -i 's/^#Port 22/Port 2020/' /etc/ssh/sshd_config

# Разрешение подключения только пользователю Server_Admin
echo "Ограничение входа только для пользователя Server_Admin..."
sed -i '/^#PermitRootLogin /c\PermitRootLogin no' /etc/ssh/sshd_config
sed -i '/^#AllowUsers /d' /etc/ssh/sshd_config
echo "AllowUsers Server_Admin" >> /etc/ssh/sshd_config

# Ограничение количества попыток входа
echo "Ограничение количества попыток входа..."
sed -i '/^#MaxAuthTries 6 /c\MaxAuthTries 3' /etc/ssh/sshd_config

# !!!Ограничение по времени аутентификации
sed -i '/^#LoginGraceTime 2m /c\LoginGraceTime 3m' /etc/ssh/sshd_config

# Настройка баннера SSH
echo "Настройка SSH баннера..."
BANNER_PATH="/etc/ssh-banner"
echo "Добро пожаловать Server_Admin!" > $BANNER_PATH
sed -i '/^#Banner none /c\Banner '"$BANNER_PATH" /etc/ssh/sshd_config

# Перезапуск службы SSH для применения изменений
echo "Перезапуск службы SSH..."
systemctl restart sshd

echo "Настройка завершена. Проверьте подключение по порту 2020 с учетной записью Server_Admin."
