#!/bin/bash

# Задать имя хоста
HOSTMAME="HQ-R"
hostnamectl set-hostname $HOSTMAME

#Настройка часового пояса
TIMEZONE="Europe/Moscow"

# Настройка сетевых интерфейсов
echo "Настройка сетевых интерфейсов..."
INTERFACE_HQ="enp0s8"  # Интерфейс в сторону офиса HQ
INTERFACE_TOISP="enp0s3"      # Интерфейс в сторону ISP
IP="192.168.220.1/27"    # задать ip интерфейсу

# Настройка DHCP сервера
dhcp_1="192.168.220.0"    #подсеть
dhcp_2="255.255.255.224"    #маска
dhcp_3="192.168.220.2 192.168.220.30"    #пул адресов
dhcp_4="192.168.220.1"    #путь по умолчанию
dhcp_5="8.8.8.8, 8.8.4.4"    #серверы DNS

# Параметры туннеля
LOCAL_IP="11.11.0.2"         # Локальный IP-адрес
REMOTE_IP="22.22.0.2"        # Удалённый IP-адрес
TUNNEL_LOCAL_IP="10.10.10.1/30"     # Локальный IP туннеля
TUNNEL_REMOTE_IP="10.10.10.2"    # Удалённый IP туннеля
TUNNEL_NAME="gre-tunnel0"      # Имя туннеля
NETWORK_BRANCH="192.168.220.0/27"
NETWORK_HQ="172.16.220.0/27"
NETWORK_TUNNEL="10.10.10.0/30"

# Расчет и назначение IP-адресов
nmcli con modify $INTERFACE_HQ ipv4.address $IP
nmcli con modify $INTERFACE_HQ ipv4.method static
systemctl restart NetworkManager

# Включение пересылки пакетов
echo "Включение IP-перенаправления..."
echo net.ipv4.ip_forward=1 > /etc/sysctl.conf
sysctl -p

# Настройка DHCP-сервера
dnf install  dhcp-server -y
echo "Настройка DHCP..."
cat <<EOF > /etc/dhcp/dhcpd.conf
default-lease-time 600;
max-lease-time 7200;


subnet $dhcp_1 netmask $dhcp_2 {
    range $dhcp_3;
    option routers $dhcp_4;
    option domain-name-servers $dhcp_5;
}
EOF
systemctl enable --now dhcpd

# Настройка nftables
dnf install -y nftables
echo "Настройка nftables..."

# Создаем файл конфигурации и записываем правила
CONFIG_FILE1="/etc/nftables/r-left.nft"
echo "Создаем файл конфигурации $CONFIG_FILE..."
touch $CONFIG_FILE1
cat > $CONFIG_FILE1 << 'EOF'
table inet nat {
    chain POSTROUTING {
        type nat hook postrouting priority srcnat;
        oifname masquerade
    }
}
EOF
sed -i "s/oifname /oifname $INTERFACE_TOISP /" $CONFIG_FILE1

# Добавляем строку include в файл /etc/sysconfig/nftables.conf
CONFIG_FILE2="/etc/sysconfig/nftables.conf"
INCLUDE_LINE='include "/etc/nftables/r-left.nft"'

echo "Добавляем строку '$INCLUDE_LINE' в файл $CONFIG_FILE..."
if ! grep -Fxq "$INCLUDE_LINE" "$CONFIG_FILE2"; then
    echo "$INCLUDE_LINE" | sudo tee -a "$CONFIG_FILE2"
    echo "Строка добавлена."
else
    echo "Строка уже существует."
fi

# Запускаем и добавляем nftables в автозагрузку
echo "Запуск сервиса nftables и добавление в автозагрузку..."
systemctl enable --now nftables

# Создание GRE туннеля
echo "Создание GRE туннеля..."

nmcli con add type ip-tunnel ip-tunnel.mode gre con-name $TUNNEL_NAME ifname $TUNNEL_NAME \
remote $REMOTE_IP local $LOCAL_IP
nmcli con mod $TUNNEL_NAME ipv4.addresses $TUNNEL_LOCAL_IP
nmcli con mod $TUNNEL_NAME ipv4.method manual
nmcli con mod $TUNNEL_NAME +ipv4.routes "$NETWORK_BRANCH $TUNNEL_REMOTE_IP"
nmcli connection modify $TUNNEL_NAME ip-tunnel.ttl 64
nmcli con up $TUNNEL_NAME

# Вывод информации о туннеле
echo "Туннель успешно настроен. Информация о туннеле:"
ip addr show $TUNNEL_NAME

#Настройка динамической (внутренней) маршрутизации средствами FRR
echo "Настройка FRR"
dnf install -y frr
sed -i "s/ospfd=no/ospfd=yes/" /etc/frr/daemons
sed -i "s/ospf6d=no/ospf6d=yes/" /etc/frr/daemons
systemctl enable --now frr

# Запись нового содержимого в файл frr.conf
cat <<EOL > /etc/frr/frr.conf
frr version 10.1
frr defaults traditional
hostname $HOSTMAME
no ipv6 forwarding
!
interface $TUNNEL_NAME
 ip ospf authentication
 ip ospf authentication-key password
 no ip ospf passive
exit
!
router ospf
 passive-interface default
 network $NETWORK_TUNNEL area 0
 network $NETWORK_HQ area 0
exit
!
EOL
echo "Файл frr.conf успешно обновлен."
systemctl restart frr

# Имя пользователя и пароль
echo "Создание пользователя $USERNAME"
# Создание пользователя
useradd -m -s /bin/bash "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd
usermod -aG wheel "$USERNAME"
# Настройка sudo без пароля
echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$USERNAME"
echo "Пользователь $USERNAME создан и настроен для использования sudo без пароля."
 
echo "установка chrony"
dnf install chrony
echo "настройка chrony"
timedatectl set-timezone Europe/Moscow
systemctl restart chronyd
systemctl enable --now  chronyd

dnf install -y nfs-utils

# Имя пользователя и пароль
USERNAME="server_admin"
PASSWORD="P@ssw0rd"
USER_ID="1010"
PORT="2020"
TIME="6m"  #Ограничение по времени

# Создание пользователя
echo "Создание пользователя $USERNAME"
useradd -m -s /bin/bash -u "$USER_ID" "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd
usermod -aG wheel "$USERNAME"
# Настройка sudo без пароля
echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$USERNAME"
echo "Пользователь $USERNAME создан и настроен для использования sudo без пароля."

# Настройка порта SSH
echo "Настройка порта SSH..."
semanage port -a -t ssh_port_t -p tcp $PORT
setenforce 0
sed -i 's/^#Port 22/Port $PORT/' /etc/ssh/sshd_config

# Разрешение подключения только пользователю $USERNAME
echo "Ограничение входа только для пользователя $USERNAME..."
sed -i '/^#PermitRootLogin /c\PermitRootLogin no' /etc/ssh/sshd_config
sed -i '/^#AllowUsers /d' /etc/ssh/sshd_config
echo "AllowUsers $USERNAM" >> /etc/ssh/sshd_config

# Ограничение количества попыток входа
echo "Ограничение количества попыток входа..."
sed -i '/^#MaxAuthTries 6 /c\MaxAuthTries 3' /etc/ssh/sshd_config

# !!!Ограничение по времени аутентификации
sed -i '/^#LoginGraceTime 2m /c\LoginGraceTime $TIME' /etc/ssh/sshd_config

# Настройка баннера SSH
echo "Настройка SSH баннера..."
BANNER_PATH="/etc/ssh-banner"
echo "Добро пожаловать $USERNAM!" > $BANNER_PATH
sed -i '/^#Banner none /c\Banner '"$BANNER_PATH" /etc/ssh/sshd_config

# Перезапуск службы SSH для применения изменений
echo "Перезапуск службы SSH..."
systemctl restart sshd

# Межсетевой экран
nft flush ruleset
# Создание таблицы фильтрации
nft add table inet filter
# Создание цепочек
nft add chain inet filter input { type filter hook input priority 0 \; }
nft add chain inet filter forward { type filter hook forward priority 0 \; }
nft add chain inet filter output { type filter hook output priority 0 \; }
# Базовые политики: блокировать всё
nft add rule inet filter input drop
nft add rule inet filter forward drop
nft add rule inet filter output accept
# Разрешить локальные loopback соединения
nft add rule inet filter input iif "lo" accept
nft add rule inet filter output oif "lo" accept
# Разрешить установленные и связанные соединения
nft add rule inet filter input ct state established,related accept
# Разрешить ICMP (ping)
nft add rule inet filter input ip protocol icmp accept
nft add rule inet filter input ip6 nexthdr icmpv6 accept
# Разрешить SSH
nft add rule inet filter input tcp dport 22 accept
# Разрешить HTTP и HTTPS
nft add rule inet filter input tcp dport 80 accept
nft add rule inet filter input tcp dport 443 accept
# Разрешить DNS
nft add rule inet filter input udp dport 53 accept
nft add rule inet filter input tcp dport 53 accept
# Разрешить NTP
nft add rule inet filter input udp dport 123 accept
# Запретить всё остальное (входящие подключения)
# Это уже задано как базовая политика: drop для input
# Сохранение конфигурации
nft list ruleset > /etc/nftables.conf
# Убедимся, что nftables запускается при загрузке
systemctl enable nftables
systemctl restart nftables
echo "Межсетевой экран настроен!"

echo "Настройка завершена."

echo "установка chrony"
dnf install chrony
echo "настройка chrony"
timedatectl set-timezone $TIMEZONE
systemctl restart chronyd
systemctl enable --now  chronyd
